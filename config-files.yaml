# ============================================================================
# BORGMATIC CONFIGURATION - FILE BACKUPS
# ============================================================================
# This configuration handles CloudPanel user directory backups
# Dynamically discovers all /home/*/htdocs directories
# Runs on 6-hourly schedule with conservative retention policy

location:
    # CloudPanel sites will be discovered via hook script
    # This file is generated by discover-htdocs.sh before each backup
    source_directories:
        - !include /etc/borgmatic/htdocs-dirs.txt
    
    # Patterns for exclusion
    patterns:
        # Node modules (JavaScript dependencies)
        - "*/node_modules"
        
        # Git repositories
        - "*/.git"
        
        # Environment files (may contain secrets)
        - "*/.env"
        - "*/.env.*"
        
        # Log files
        - "*/logs"
        - "*/log"
        
        # Cache directories
        - "*/cache"
        - "*/tmp"
        - "*/temp"
        
        # Backup directories (avoid infinite loops)
        - "*/backup"
        - "*/backups"
        
        # IDE files
        - "*/.vscode"
        - "*/.idea"
        
        # OS files
        - "*/.DS_Store"
        - "*/Thumbs.db"
    
    # Ignore if the dynamic file doesn't exist yet
    source_directories_mismatch: ignore

storage:
    # Files repository location
    repositories:
        - path: ssh://{{ env "BORG_REMOTE_USER" | default("backup_user") }}@{{ env "BORG_REMOTE_HOST" | default("backup.server.com") }}/{{ env "BORG_REMOTE_PATH_FILES" | default("./files") }}
          label: files
          extra_borg_options:
                rsh: ssh -i {{ env "SSH_PRIVATE_KEY" | default("~/.ssh/borgBackup") }} -p {{ env "SSH_PORT" | default("22") }}
    
    # Encryption passphrase
    encryption_passphrase: {{ env "BORG_PASSPHRASE" | default("changeme") }}
    
    # Compression type
    compression: {{ env "BORG_COMPRESSION" | default("lzma") }}
    
    # Archive name template
    archive_name_format: sites-{now:%Y-%m-%d_%H-%M}

# ----------------------------------------------------------------------------
# RETENTION POLICY - FILES
# ----------------------------------------------------------------------------
retention:
    keep_daily: 7         # 7 days of daily backups
    keep_weekly: 12       # 12 weeks of weekly backups
    keep_monthly: 12      # 12 months of monthly backups
    keep_yearly: 10       # 10 years of yearly backups
    prefix: sites-

# ----------------------------------------------------------------------------
# CONSISTENCY CHECKS
# ----------------------------------------------------------------------------
consistency:
    checks:
        - name: repository
        - name: archives
          frequency: 2 weeks
    check_last: 3

# ----------------------------------------------------------------------------
# OUTPUT OPTIONS
# ----------------------------------------------------------------------------
output:
    log_file: /var/log/borgmatic-files.log
    # Send logs to systemd journal
    log_file_level: info

# ----------------------------------------------------------------------------
# MONITORING & NOTIFICATIONS
# ----------------------------------------------------------------------------
# Health checks (optional)
# Uncomment and configure if using healthchecks.io
# healthchecks:
#     ping_url: https://hc-ping.com/your-uuid

# Apprise for notifications (Telegram, email, etc.)
# Uncomment and configure APRISE_URL in .env to enable
# monitoring:
#     - apprise: {{ env "APRISE_URL" | default("") }}

# ----------------------------------------------------------------------------
# HOOKS
# ----------------------------------------------------------------------------
hooks:
    # Run before backup starts
    before_backup:
        # Discover CloudPanel htdocs directories
        - /usr/local/bin/discover-htdocs.sh
        # Notify start
        - echo "Starting file backup at $(date)"
    
    # Run after backup completes successfully
    after_backup:
        # Notify completion
        - echo "File backup completed successfully at $(date)"
        # Optional: Show backup statistics
        - echo "Backup size and duration logged in /var/log/borgmatic-files.log"
    
    # Run on backup failure
    on_error:
        - echo "File backup failed at $(date)"
        - echo "Check /var/log/borgmatic-files.log for details"
        - echo "Check /etc/borgmatic/htdocs-dirs.txt for discovered directories"